<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Lumo 2FA â€“ é›¶çŸ¥è¯†ã€ç¦»çº¿ä¼˜å…ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.webmanifest" />
<link rel="icon" href="data:," />
<style>
:root{ --bg:#0B0B0D; --card:#1C1C1E; --primary:#06C167; --text-primary:rgba(255,255,255,.87); --text-secondary:rgba(255,255,255,.6); --success:#34C759; --danger:#FF3B30; }
body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text-primary); }
.container{max-width:720px;margin:auto;padding:1rem;}
.card{ background:var(--card); border-radius:12px; padding:1rem; margin-top:1rem; backdrop-filter:blur(6px); }
button{ height:44px;min-width:44px; border:none;border-radius:10px; background:var(--primary);color:#fff; font-weight:600;cursor:pointer; }
button:disabled{opacity:.5;cursor:not-allowed;}
input{ width:100%;padding:.5rem;margin:.3rem 0; border:1px solid #444;border-radius:6px; background:#222;color:#fff; }
.toast{ position:fixed;bottom:20px;left:50%;transform:translateX(-50%); padding:.8rem 1.2rem;border-radius:8px;color:#fff; animation:fade .3s forwards;z-index:9999;}
.toast.success{background:var(--success);} .toast.error{background:var(--danger);}
@keyframes fade{from{opacity:0;}to{opacity:1;}}
.progress-ring{ position:relative;width:48px;height:48px; } .progress-ring circle{ fill:none;stroke:#555;stroke-width:4; } .progress-ring .progress{ stroke:var(--primary);stroke-linecap:round; transform:rotate(-90deg);transform-origin:center; }
table{width:100%;border-collapse:collapse;} td,th{padding:.6rem;border-bottom:1px solid rgba(255,255,255,.04); text-align:left;}
.code-cell{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; font-size:1.25rem;}
.small{font-size:.85rem;color:var(--text-secondary);}
.floater{position:fixed;right:18px;bottom:18px;background:var(--primary);color:#fff;border-radius:999px;border:none;width:56px;height:56px;font-size:22px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
</style>
</head>
<body>
<div class="container">
  <div id="auth-section" class="card">
    <h3>ç™»å½• / æ³¨å†Œ</h3>
    <input id="email" type="email" placeholder="é‚®ç®±">
    <input id="pwd" type="password" placeholder="å¯†ç ">
    <div style="display:flex;gap:.5rem;">
      <button id="signin">ç™»å½•</button>
      <button id="signup">æ³¨å†Œ</button>
    </div>
    <p id="auth-msg" class="small"></p>
  </div>

  <div id="app-section" style="display:none;">
    <div class="card">
      <p>å·²ç™»å½•ï¼š<span id="user-email"></span>
      <button id="signout" style="float:right;background:#444;">é€€å‡º</button></p>
    </div>

    <div class="card" id="master-pwd-card">
      <h4>ä¸»å¯†ç ï¼ˆæœ¬åœ°æ´¾ç”Ÿå¯†é’¥ï¼‰</h4>
      <input id="master-pwd" type="password" placeholder="è¾“å…¥ä¸»å¯†ç ï¼ˆç”¨äºæœ¬åœ°è§£å¯†ï¼‰">
      <div style="display:flex;gap:.5rem;">
        <button id="save-master-pwd">ä¿å­˜ä¸»å¯†ç </button>
        <button id="forget-master-pwd" style="background:#444;">å¿˜è®°ä¸»å¯†ç ï¼ˆä»…æœ¬åœ°ï¼‰</button>
      </div>
      <p id="master-msg" class="small"></p>
    </div>

    <div class="card">
      <h4>äº‘å¤‡ä»½ï¼ˆé›¶çŸ¥è¯†ï¼‰</h4>
      <label><input type="checkbox" id="cloud-toggle"> å¯ç”¨äº‘å¤‡ä»½ï¼ˆåŠ å¯†åä¸Šä¼ åˆ° Firestoreï¼‰</label>
      <p id="cloud-msg" class="small">å¼€å¯åä¼šæŠŠåŠ å¯†åŒ…ä¸Šä¼ åˆ°ç”¨æˆ·ç§æœ‰æ–‡æ¡£ã€‚åç»­è®¾å¤‡ç™»å½•å¹¶æä¾›ä¸»å¯†ç å³å¯è§£å¯†æ¢å¤ã€‚</p>
    </div>

    <div class="card">
      <h4>æ·»åŠ æ–°è´¦æˆ·</h4>
      <button id="scan-qr">ğŸ“· æ‰«æäºŒç»´ç </button>
      <div id="qr-reader" style="width:320px;margin-top:.5rem;"></div>
      <input id="new-label" placeholder="æœåŠ¡åç§°ï¼ˆå¦‚ GitHubï¼‰">
      <input id="new-secret" placeholder="Base32 ç§˜é’¥ï¼ˆæˆ–ç²˜è´´ otpauth:// URIï¼‰">
      <div style="display:flex;gap:.5rem;">
        <button id="add-account">æ·»åŠ è´¦æˆ·</button>
        <button id="import-json" style="background:#444;">ä» JSON å¯¼å…¥</button>
        <button id="export-json" style="background:#222;">å¯¼å‡ºï¼ˆåŠ å¯†åŒ…ï¼‰</button>
      </div>
      <p id="add-msg" class="small"></p>
    </div>

    <div class="card">
      <h4>æˆ‘çš„ TOTP åˆ—è¡¨</h4>
      <table id="account-table">
        <thead><tr><th>æœåŠ¡</th><th>ä»£ç </th><th>å‰©ä½™</th><th>æ“ä½œ</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<button class="floater" id="quick-add" title="å¿«é€Ÿæ·»åŠ ">ï¼‹</button>

<!-- third-party libs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/otplib@12.0.1/otplib-browser.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

<script>
/* ================= Firebase é…ç½®ï¼ˆæ›¿æ¢ï¼‰ ================= */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ================= æœ¬åœ°å­˜å‚¨ ================= */
const STORE = localforage.createInstance({name:"lumo-2fa"});
// seeds: [{id,label,encrypted:{ct,iv,salt}}]

/* ================= å·¥å…·ï¼šUint8/BASE64/UTF8 ================= */
function u8ToB64(u){ return btoa(String.fromCharCode(...u)); }
function b64ToU8(b){ return Uint8Array.from(atob(b),c=>c.charCodeAt(0)); }
const encoder = new TextEncoder();
const decoder = new TextDecoder();
async function sha256(text){ const h=await crypto.subtle.digest('SHA-256', encoder.encode(text)); return u8ToB64(new Uint8Array(h)); }

/* ================= å¯†é’¥æ´¾ç”Ÿ + åŠ å¯† ================= */
async function deriveKey(pwd, saltU8){
  const baseKey = await crypto.subtle.importKey('raw', encoder.encode(pwd), {name:'PBKDF2'}, false, ['deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2', salt: saltU8, iterations:200000, hash:'SHA-256'}, baseKey, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']);
}
async function encryptSecret(secret, pwd){
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await deriveKey(pwd, salt);
  const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, encoder.encode(secret));
  return { ct: new Uint8Array(ct), iv, salt };
}
async function decryptSecret(blob, pwd){
  const {ct, iv, salt} = blob;
  const key = await deriveKey(pwd, salt);
  const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
  return decoder.decode(pt);
}

/* ================= UI å°å·¥å…· ================= */
function toast(msg, type='success'){
  const el = document.createElement('div'); el.className='toast '+(type==='error'?'error':'success'); el.textContent=msg; document.body.appendChild(el);
  setTimeout(()=>el.remove(), 3000);
}
function showMsg(id, txt){ document.getElementById(id).textContent = txt; }

/* ================= Auth ================= */
document.getElementById('signin').onclick = async ()=>{
  const email=document.getElementById('email').value.trim();
  const pwd=document.getElementById('pwd').value;
  try{ await auth.signInWithEmailAndPassword(email,pwd); }catch(e){ showMsg('auth-msg', e.message); }
};
document.getElementById('signup').onclick = async ()=>{
  const email=document.getElementById('email').value.trim();
  const pwd=document.getElementById('pwd').value;
  try{ await auth.createUserWithEmailAndPassword(email,pwd); }catch(e){ showMsg('auth-msg', e.message); }
};
document.getElementById('signout').onclick = ()=> auth.signOut();

/* ================= seeds å†…å­˜ç®¡ç† ================= */
let seeds = []; // [{id,label,encrypted:{ct,iv,salt}}]
async function loadSeedsFromLocal(){ seeds = await STORE.getItem('seeds') || []; }
async function saveSeedsToLocal(){ await STORE.setItem('seeds', seeds); }

/* ================= auth state ================= */
auth.onAuthStateChanged(async u=>{
  if(u){
    document.getElementById('user-email').textContent = u.email || u.uid;
    document.getElementById('auth-section').style.display='none';
    document.getElementById('app-section').style.display='block';
    await loadSeedsFromLocal();
    const cloudEnabled = await STORE.getItem('cloudEnabled');
    document.getElementById('cloud-toggle').checked = !!cloudEnabled;
    renderTable();
    startTicker();
    if(cloudEnabled) await syncFromCloud();
  }else{
    document.getElementById('auth-section').style.display='block';
    document.getElementById('app-section').style.display='none';
  }
});

/* ================= ä¸»å¯†ç ç®¡ç† ================= */
document.getElementById('save-master-pwd').onclick = async ()=>{
  const pwd = document.getElementById('master-pwd').value.trim();
  if(!pwd){ toast('è¯·è¾“å…¥ä¸»å¯†ç ','error'); return; }
  const hash = await sha256(pwd);
  await STORE.setItem('masterHash', hash);
  // å°è¯•å­˜åˆ° Credential Manager ä»¥ä¾¿ä¸‹æ¬¡è‡ªåŠ¨æ¢å¤ï¼ˆå¯é€‰ï¼‰
  try{
    if(navigator.credentials && navigator.credentials.store){
      await navigator.credentials.store(new PasswordCredential({id:'lumo-master-key', password:pwd, name:'Lumo Master'}));
    }
  }catch(e){ /* ignore */ }
  showMsg('master-msg','å·²ä¿å­˜ä¸»å¯†ç ï¼ˆä»…æœ¬åœ°ï¼Œç”¨äºè§£å¯†ï¼‰');
  startTicker();
};
document.getElementById('forget-master-pwd').onclick = async ()=>{
  await STORE.removeItem('masterHash'); document.getElementById('master-pwd').value=''; showMsg('master-msg','å·²æ¸…é™¤æœ¬åœ°ä¸»å¯†ç å¿«ç…§');
};

/* ================= æ·»åŠ è´¦æˆ· ================= */
document.getElementById('add-account').onclick = async ()=>{
  let label = document.getElementById('new-label').value.trim();
  let secretRaw = document.getElementById('new-secret').value.trim();
  if(!secretRaw){ toast('è¯·è¾“å…¥ secret æˆ– otpauth:// URI','error'); return; }
  // æ”¯æŒ otpauth URI ç²˜è´´
  if(secretRaw.toLowerCase().startsWith('otpauth://')){
    try{
      const u = new URL(secretRaw);
      secretRaw = u.searchParams.get('secret') || '';
      const issuer = u.searchParams.get('issuer') || u.pathname.split(':')[1] || '';
      if(!label) label = issuer;
    }catch(e){ toast('otpauth URI è§£æå¤±è´¥','error'); return; }
  }
  secretRaw = secretRaw.replace(/\s+/g,'').toUpperCase();
  if(!/^[A-Z2-7]+=*$/.test(secretRaw)){ toast('Base32 ç§˜é’¥éæ³•ï¼Œåªèƒ½åŒ…å« A-Zã€2-7','error'); return; }
  if(!label) { toast('è¯·å¡«å†™æœåŠ¡åç§°','error'); return; }
  const masterPwd = document.getElementById('master-pwd').value.trim();
  if(!masterPwd){ toast('è¯·å…ˆè¾“å…¥ä¸»å¯†ç å¹¶ä¿å­˜','error'); return; }
  try{
    const enc = await encryptSecret(secretRaw, masterPwd);
    const newSeed = { id: crypto.randomUUID(), label, encrypted:{ ct:u8ToB64(enc.ct), iv:u8ToB64(enc.iv), salt:u8ToB64(enc.salt) } };
    seeds.push(newSeed);
    await saveSeedsToLocal();
    renderTable();
    toast('å·²æ·»åŠ è´¦æˆ·');
    if(document.getElementById('cloud-toggle').checked) await syncToCloud();
  }catch(e){ toast('åŠ å¯†å¤±è´¥ï¼š'+e.message,'error'); }
};

/* ================= æ¸²æŸ“ & TOTP ================= */
function renderTable(){
  const tbody = document.querySelector('#account-table tbody'); tbody.innerHTML='';
  seeds.forEach(seed=>{
    const tr = document.createElement('tr'); tr.dataset.id = seed.id;
    tr.innerHTML = `<td>${escapeHtml(seed.label)}</td><td class="code-cell">â€”</td><td class="remain">â€”</td><td>
      <button class="copy-btn">å¤åˆ¶</button>
      <button class="del-btn" style="background:#444;">åˆ é™¤</button>
    </td>`;
    tbody.appendChild(tr);
  });
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

let ticker=null;
function startTicker(){
  if(ticker) clearInterval(ticker);
  ticker = setInterval(async ()=>{
    const masterPwd = document.getElementById('master-pwd').value.trim();
    const now = Math.floor(Date.now()/1000);
    const step = 30;
    const secondsLeft = step - (now % step);
    for(const row of document.querySelectorAll('#account-table tbody tr')){
      const id = row.dataset.id;
      const seed = seeds.find(s=>s.id===id);
      if(!seed) continue;
      const codeCell = row.querySelector('.code-cell');
      const remainCell = row.querySelector('.remain');
      if(!masterPwd){ codeCell.textContent='â€”'; remainCell.textContent='â€”'; continue; }
      try{
        const enc = seed.encrypted;
        const secret = await decryptSecret({ ct:b64ToU8(enc.ct), iv:b64ToU8(enc.iv), salt:b64ToU8(enc.salt) }, masterPwd);
        otplib.totp.options = { digits: 6, step: 30 };
        const code = otplib.totp.generate(secret);
        codeCell.textContent = code;
        remainCell.textContent = String(secondsLeft)+'s';
      }catch(e){
        codeCell.textContent='âŒ'; remainCell.textContent='â€”';
      }
    }
  }, 1000);
}
startTicker();

/* å¤åˆ¶ä¸åˆ é™¤ */
document.querySelector('#account-table tbody').addEventListener('click', async e=>{
  const btn = e.target; const tr = btn.closest('tr'); if(!tr) return; const id = tr.dataset.id;
  if(btn.classList.contains('copy-btn')){ const code = tr.querySelector('.code-cell').textContent; if(code && code!=='â€”' && code!=='âŒ'){ await navigator.clipboard.writeText(code); toast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'); } }
  if(btn.classList.contains('del-btn')){ if(!confirm('ç¡®å®šåˆ é™¤æ­¤æ¡è®°å½•ï¼Ÿ')) return; seeds = seeds.filter(s=>s.id!==id); await saveSeedsToLocal(); tr.remove(); toast('å·²åˆ é™¤'); if(document.getElementById('cloud-toggle').checked) await syncToCloud(); }
});

/* ================= QR æ‰«æ ================= */
let scanner=null;
document.getElementById('scan-qr').onclick = ()=>{
  if(scanner){ scanner.clear(); scanner=null; document.getElementById('qr-reader').innerHTML=''; return; }
  scanner = new Html5Qrcode("qr-reader");
  scanner.start({ facingMode:"environment" }, { fps:10, qrbox:250 }, decoded=>{
    try{
      // æ”¯æŒ otpauth URI æˆ–ç›´æ¥ secret
      if(decoded.toLowerCase().startsWith('otpauth://')){
        const u = new URL(decoded);
        const s = u.searchParams.get('secret'); const issuer = u.searchParams.get('issuer') || u.pathname.split(':')[1] || '';
        if(s){ document.getElementById('new-label').value = issuer; document.getElementById('new-secret').value = s; toast('äºŒç»´ç å·²è¯»å–'); }
      }else{
        document.getElementById('new-secret').value = decoded; toast('äºŒç»´ç å·²è¯»å–');
      }
    }catch(err){ toast('äºŒç»´ç è§£æå¤±è´¥','error'); }
    scanner.stop().then(()=>{ scanner.clear(); scanner=null; document.getElementById('qr-reader').innerHTML=''; });
  }, err=>{ /* å¿½ç•¥æ‰«æé”™è¯¯ */ });
};

/* ================= äº‘å¤‡ä»½ï¼šsyncToCloud / syncFromCloud ================= */
/*
Backup doc path: users/{uid}/backup
Structure:
{ version:1, encrypted: <base64>, iv:<base64>, salt:<base64>, updatedAt: Timestamp }
*/
document.getElementById('cloud-toggle').addEventListener('change', async (e)=>{
  const on = e.target.checked;
  await STORE.setItem('cloudEnabled', !!on);
  if(on){
    // ç›´æ¥å°è¯•åŒæ­¥ä¸Šäº‘ï¼ˆéœ€è¦ä¸»å¯†ç ï¼‰
    toast('å·²å¯ç”¨äº‘å¤‡ä»½ï¼Œç¨ååŒæ­¥');
    await syncToCloud();
  }else{
    toast('å·²åœç”¨äº‘å¤‡ä»½ï¼ˆæœ¬åœ°ä»ä¿ç•™åŠ å¯†æ•°æ®ï¼‰');
  }
});

async function syncToCloud(){
  const user = auth.currentUser;
  if(!user){ toast('è¯·å…ˆç™»å½•ä»¥ä½¿ç”¨äº‘å¤‡ä»½','error'); return; }
  const masterPwd = document.getElementById('master-pwd').value.trim();
  if(!masterPwd){ toast('ä¸Šä¼ å‰éœ€è¾“å…¥ä¸»å¯†ç ','error'); return; }
  try{
    // åºåˆ—åŒ– seeds å¹¶åŠ å¯†æ•´ä¸ªåŒ…
    const payload = JSON.stringify(seeds);
    const enc = await encryptSecret(payload, masterPwd);
    const docRef = db.collection('users').doc(user.uid).collection('meta').doc('backup');
    await docRef.set({
      version:1,
      encrypted: u8ToB64(enc.ct),
      iv: u8ToB64(enc.iv),
      salt: u8ToB64(enc.salt),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    toast('äº‘å¤‡ä»½å·²ä¸Šä¼ ');
  }catch(e){ toast('äº‘å¤‡ä»½å¤±è´¥ï¼š'+e.message,'error'); }
}

async function syncFromCloud(){
  const user = auth.currentUser;
  if(!user){ return; }
  try{
    const docRef = db.collection('users').doc(user.uid).collection('meta').doc('backup');
    const snap = await docRef.get();
    if(!snap.exists){ showMsg('cloud-msg','æœªæ‰¾åˆ°äº‘å¤‡ä»½'); return; }
    const data = snap.data();
    if(!data || !data.encrypted){ showMsg('cloud-msg','äº‘å¤‡ä»½æ•°æ®æ ¼å¼å¼‚å¸¸'); return; }
    const masterPwd = document.getElementById('master-pwd').value.trim();
    if(!masterPwd){ showMsg('cloud-msg','è¯·å…ˆè¾“å…¥ä¸»å¯†ç ä»¥è§£å¯†äº‘å¤‡ä»½'); return; }
    const ct = b64ToU8(data.encrypted);
    const iv = b64ToU8(data.iv);
    const salt = b64ToU8(data.salt);
    const decrypted = await decryptSecret({ct,iv,salt}, masterPwd);
    const parsed = JSON.parse(decrypted);
    if(!Array.isArray(parsed)){ showMsg('cloud-msg','äº‘å¤‡ä»½å†…å®¹éé¢„æœŸæ ¼å¼'); return; }
    // åˆå¹¶æœ¬åœ°ï¼ˆå»é‡ by idï¼‰
    const remoteSeeds = parsed;
    const localIds = new Set(seeds.map(s=>s.id));
    for(const s of remoteSeeds) if(!localIds.has(s.id)) seeds.push(s);
    await saveSeedsToLocal();
    renderTable(); toast('å·²ä»äº‘å¤‡ä»½æ¢å¤å¹¶åˆå¹¶æœ¬åœ°æ•°æ®');
  }catch(e){ toast('æ¢å¤äº‘å¤‡ä»½å¤±è´¥ï¼š'+e.message,'error'); }
}

/* ================= å¯¼å‡º / å¯¼å…¥ JSONï¼ˆåŠ å¯†åŒ…ï¼‰ ================= */
document.getElementById('export-json').onclick = async ()=>{
  const masterPwd = document.getElementById('master-pwd').value.trim();
  if(!masterPwd){ toast('è¯·è¾“å…¥ä¸»å¯†ç ä»¥å¯¼å‡º','error'); return; }
  try{
    const payload = JSON.stringify(seeds);
    const enc = await encryptSecret(payload, masterPwd);
    const out = { version:1, encrypted:u8ToB64(enc.ct), iv:u8ToB64(enc.iv), salt:u8ToB64(enc.salt) };
    const blob = new Blob([JSON.stringify(out,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='lumo-backup.json'; a.click(); URL.revokeObjectURL(url);
    toast('å·²å¯¼å‡ºåŠ å¯†å¤‡ä»½æ–‡ä»¶');
  }catch(e){ toast('å¯¼å‡ºå¤±è´¥ï¼š'+e.message,'error'); }
};

document.getElementById('import-json').onclick = async ()=>{
  const input = document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange = async ()=>{
    const f = input.files[0]; if(!f) return;
    const s = await f.text();
    try{
      const obj = JSON.parse(s);
      if(!obj.encrypted){ toast('æ–‡ä»¶æ ¼å¼ä¸å¯¹','error'); return; }
      const masterPwd = document.getElementById('master-pwd').value.trim();
      if(!masterPwd){ toast('è¯·è¾“å…¥ä¸»å¯†ç ä»¥è§£å¯†å¯¼å…¥','error'); return; }
      const decrypted = await decryptSecret({ ct:b64ToU8(obj.encrypted), iv:b64ToU8(obj.iv), salt:b64ToU8(obj.salt) }, masterPwd);
      const parsed = JSON.parse(decrypted);
      if(!Array.isArray(parsed)){ toast('å¤‡ä»½å†…å®¹æ ¼å¼å¼‚å¸¸','error'); return; }
      // åˆå¹¶å¹¶ä¿å­˜
      const localIds = new Set(seeds.map(s=>s.id));
      for(const s of parsed) if(!localIds.has(s.id)) seeds.push(s);
      await saveSeedsToLocal(); renderTable(); toast('å¯¼å…¥æˆåŠŸå¹¶å·²åˆå¹¶æœ¬åœ°');
      if(document.getElementById('cloud-toggle').checked) await syncToCloud();
    }catch(e){ toast('å¯¼å…¥å¤±è´¥ï¼š'+e.message,'error'); }
  };
  input.click();
};

/* ================= å¿«æ·æŒ‰é’® ================= */
document.getElementById('quick-add').onclick = ()=>{ document.getElementById('new-label').focus(); };

/* ================= é¡µé¢è½½å…¥æ—¶å°è¯•æ¢å¤ credential manager ä¸»å¯†ç ï¼ˆå¯é€‰ï¼‰ ================= */
(async ()=>{
  try{
    if(navigator.credentials && navigator.credentials.get){
      const c = await navigator.credentials.get({password:true, mediation:'silent'});
      if(c && c.password){
        document.getElementById('master-pwd').value = c.password;
        const h = await sha256(c.password); await STORE.setItem('masterHash', h);
        showMsg('master-msg','å·²ä»æµè§ˆå™¨å‡­æ®æ¢å¤ä¸»å¯†ç ï¼ˆæœ¬åœ°ï¼‰');
        startTicker();
      }
    }
  }catch(e){ /* ignore */ }
})();
</script>
</body>
</html>
